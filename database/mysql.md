# mysql





QPS ：每秒处理的查量

TPS：每秒事物数

1. 超高的QPS和TPS

2. 大量的并发和超高的cpu使用率

   - 大量的并发：数据库连接数倍占满（max_connections,默认100)
   - 超高的cpu使用率：因cpu自由耗尽而出现宕机。

3. 磁盘io，磁盘io性能突然下降。（大促前调整维护计划）

4. 网卡流量：网卡io被占满（1000Mb/8 相当于 100MB）

   - 减少从服务器的数量
   - 进行分级缓存
   - 避免使用“select *”进行查询
   - 分离业务网络和服务器网络

5. 其他

   - 大表带来的问题（数据量超过千万行，表数据文件巨大，超过10G）

     - 慢查询：很难再一定的时间内过滤出所需要的数据
     - 建立索引需要很长时间，mysql<5.5 会锁表，>5.5引起主从延迟。
     - 修改表结构需要长时间锁表

     解决大表问题

     - 分库分表（很少这么做），难点：分表主键选择，分表后跨分区数据的查询和统计。
     - 大表的历史数据归档，减少对前后断业务的影响。难点：归档时间点的选择，如何进行归档操作

   - 大事物带来的问题

     事务时数据库系统区别于其他一切文件系统的重要特性之一

     事务是一组具有原子性的sql语句。原子性、一致性、隔离性（未提交读、已提交读、可重复读，可串行化（很少使用））、持久性。

     定义：运行时间比较长，操作的数据比较多的事务。

     - 锁定太多的数据，造成大量的阻塞和锁超时。
     - 回滚所需时间比较长
     - 执行时间长，容易造成主从延迟

     怎样处理大事物：

     - 避免一次处理太多的数据
     - 移除不必要在事务中的select操作


![image-20190201234408042](/Users/zengxiangfei/Documents/Wiki/mywiki/database/images/image-20190201234408042.png)



目前mysql不支持多cpu并发运算。



## 什么影响了Mysql性能

那些因素影响数据库性能：

1. 硬件情况
2. 服务器操作系统，参数等
3. 数据库存储引擎
4. 数据库参数配置
5. 数据库结构设计和SQL语句



### 硬件情况

是需要更好的cpu还是更多的cpu。

1. web项目适合更多的cpu
2. 使用多个cpu需要选择更好的mysql版本



#### 磁盘：

1. 传统磁盘，存储空间大，速度较慢。要选择转速快的。

2. raid技术，磁盘冗余队列的简称。简单来说Raid的作用就是把多个容量较小的磁盘组成一组容量更大的磁盘，并提供数据冗余来保证数据完整性的技术。

   主要的raid级别

   - raid 0 ： 组建磁盘整列最简单的形式，简单来说就是多个读磁盘组合在一起，没有提供冗余或错误修复能力。
   - raid 1：有成为磁盘镜像。磁盘利用率仅有50%，成本高。数据冗余性好，读性能较好。大部分操作系统都可以通过软件实现raid 0 和raid1.
   - raid 5 ：分布式奇偶校验磁盘阵列。整个整列只需要一块冗余。写很慢，随机读很快，适合以读为主的业务。最好使用在从数据库服务器上。
   - raid 10 ：又称为分片的镜像。读写性能好，重建会很简单。

   ![image-20190202161815719](/Users/zengxiangfei/Documents/Wiki/mywiki/database/images/image-20190202161815719.png)

   raid级别选择：

   ![image-20190202161906635](/Users/zengxiangfei/Documents/Wiki/mywiki/database/images/image-20190202161906635.png)

#### 固态存储

优缺点：

- 相比于机械磁盘，固态磁盘有更好的随机读写性能

- 相比机械磁盘，固态磁盘能更好的支持并发

- 相比机械磁盘，固态磁盘更容易损坏

ssd：使用sata接口，可以替代传统磁盘而不需要任何改动。sata接口的ssd同样支持raid技术。

pci-E ssd：无法使用sata接口，需要独特的驱动和配置。价格比ssd要贵，性能比ssd好。

使用场景

- 适用于存在大量随机i/o的场景，热数据大小远大于内存。
- 适用于解决单线程负载的i/o瓶颈，比如从服务器上（单线程，易损耗）。



网络存储san和nas

是两种外部文件存储设备加载到服务器上的方法。

san设备通过光纤连接到服务器，设备通过块接口访问，服务器可以将其当作磁盘使用。

- 适合大量顺序读写，随机读写慢，不如本地raid磁盘。

nas设备使用网络连接，通过基于文件的协议如nfs或smb来访问，通过有网络传输的延迟。

适合场景：

- 网络存储不适合于mysql数据库存放数据，有人使用网络存储来实现高可用（牺牲性能）。
- 适合数据库备份



#### 网络性能限制：

延迟 带宽

- 采用高性能和高带宽的网络接口设备和交换机
- 对多个网卡进行绑定，增强可用性和带宽
- 尽可能进行网络隔离













